<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Loop all fast and secure </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Loop all fast and secure ">
    <meta name="generator" content="docfx 2.51.0.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h2 id="loop-all-fast-and-secure">Loop all fast and secure</h2>

<p>This article will describe how to loop players, vehicles, ect. fast and secure.</p>
<p>You first have to create a custom class that implements the callback interface.</p>
<p>There are two callback interfaces to implement.</p>
<ol>
<li><p><code>IBaseObjectCallback</code> is used for none async code.
The loop execution also blocks the execution on the main thread.
You should also not use async code within the callback (or at least lock usage of entities).</p>
</li>
<li><p><code>IAsyncBaseObjectCallback</code> which is for calling async code in it.
The callback gets executed inside of an own task and therefore is awaitable.
Use this callback class either when you have to execute asynchronous code inside the loop or when the loop call itself gets executed asynchronously (not in main thread).
The entity object parameter by using this callback class is validated and it is safe to be used outside of the main thread without need of using lock statements.
Remember that you have to inherit your resource class from <code>AsyncResource</code> (AltAsync package) instead of <code>Resource</code>, otherwise you don't have entity validation.</p>
</li>
</ol>
<p>Technically both callbacks, no mather the interface can be called in async code. <code>IAsyncBaseObjectCallback</code> will result in returning a Task and uses async safe entity references (like <code>AsyncPlayerRef</code> instead of <code>PlayerRef</code> when iterating over players).</p>
<p>This example is for IPlayer's but can be used for <code>IVehicle</code>, <code>IBlip</code>, <code>ICheckpoint</code>, <code>IColShape</code> and <code>IVoiceChannel</code> as well.</p>
<pre><code class="lang-csharp">class MyPlayerCallback
    : IBaseObjectCallback&lt;IPlayer&gt;
{
    public void OnBaseObject(IPlayer player)
    {
        // do something
        CheckPlayerPosition(player.Position);
    }
}

class MyPlayerSaveToDBCallback
    : IAsyncBaseObjectCallback&lt;IPlayer&gt;
{
    public async Task OnBaseObject(IPlayer player)
    {
        // do something
        var dbPlayer = await LoadPlayerFromDb(player.Id);
        await SavePlayer(dbPlayer);
    }
}
</code></pre>
<p>Now you can create some class instances.</p>
<pre><code class="lang-csharp">var myPlayerCallback = new MyPlayerCallback();

var myPlayerSaveToDBCallback = new MyPlayerSaveToDbCallback();
</code></pre>
<p>Now you can trigger the OnBaseObject calls inside them.</p>
<pre><code class="lang-csharp">await Alt.ForEachPlayers(myPlayerSaveToDBCallback);
Alt.ForEachPlayers(myPlayerCallback);
</code></pre>
<p>As you can see the <code>ForEachPlayers</code> method returns a Task that is done when all OnBaseObject calls that return a Task are done as well.
They are currently called sequently.</p>
<p>Its allowed to reuse the created class instances for as many calls as you want.</p>
<p>Exceptions inside a callback will result into the method to fail and forward the exception to the caller.</p>
<h3 id="function--lambda-callbacks">Function / lambda callbacks</h3>
<p>Since writing multiple classes for each iteration purpose can be exhausting, you can also use these two generic callback implementations.
With them you can use lambda expressions to define the loop code.
Just keep in mind that using classes is better in performance than using lambda functions (which is probably negligible).</p>
<pre><code class="lang-csharp">public class FunctionCallback&lt;T&gt;
    : IBaseObjectCallback&lt;T&gt;
    where T : IBaseObject
{
    private readonly Action&lt;T&gt; _callback;

    public FunctionCallback(Action&lt;T&gt; callback)
    {
        _callback = callback;
    }

    public void OnBaseObject(T baseObject)
    {
        _callback(baseObject);
    }
}

public class AsyncFunctionCallback&lt;T&gt;
    : IAsyncBaseObjectCallback&lt;T&gt;
    where T : IBaseObject
{
    private readonly Func&lt;T, Task&gt; _callback;

    public AsyncFunctionCallback(Func&lt;T, Task&gt; callback)
    {
        _callback = callback;
    }

    public Task OnBaseObject(T baseObject)
    {
        return _callback(baseObject);
    }
}
</code></pre>
<p>Usage:</p>
<pre><code class="lang-csharp">var callback = new FunctionCallback&lt;IPlayer&gt;(player =&gt; {
    // do something
    CheckPlayerPosition(player.Position);
});

Alt.ForEachPlayers(callback);
</code></pre>
<pre><code class="lang-csharp">var asyncCallback = new AsyncFunctionCallback&lt;IPlayer&gt;(async (player) =&gt; {
    // do something
    var dbPlayer = await LoadPlayerFromDb(player.Id);
    await SavePlayer(dbPlayer);
});

Alt.ForEachPlayers(asyncCallback);
</code></pre>
<p>If you need entity validation without having the need for using await statement you can do this:</p>
<pre><code class="lang-csharp">var asyncCallback = new AsyncFunctionCallback&lt;IPlayer&gt;(async (player) =&gt; {
    // do something
    Alt.Log(player.Name);
    await Task.CompletedTask; // you need at least one await statement in async methods
});

Alt.ForEachPlayers(asyncCallback);
</code></pre>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/FabianTerhorst/coreclr-module/blob/master/docs/articles/loop-all.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
